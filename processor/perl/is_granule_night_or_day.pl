#!/usr/local/bin/perl

#  Copyright 2012, by the California Institute of Technology.  ALL RIGHTS
#  RESERVED. United States Government Sponsorship acknowledged. Any commercial
#  use must be negotiated with the Office of Technology Transfer at the
#  California Institute of Technology.
#
# $Id$
# DO NOT EDIT THE LINE ABOVE - IT IS AUTOMATICALLY GENERATED BY CM

# Function will call an IDL program to read the global attribute of an uncompressed HDF file to check to see if it is Day, Night, or Mixed.
#------------------------------------------------------------------------------------------------

sub is_granule_night_or_day {

    # Returned status.  Value of 0 means ok, 1 means bad.

    my $o_night_or_day_flag = 'Day';  # Assume if it Day as default.

    # Get input.

    my $i_sst_filename = $_[0]; 

    my $debug_module = "is_granule_night_or_day:";
    my $debug_mode   = 0;

    # Given the below 2 names:
    #
    #     A2007060011500.LAC_GSSTD
    #     A2007060011500.LAC_GSSTN
    #
    # attempt to figure out if it is day or night from the name.  If cannot, then open up the file to read it.
    # The VIIRS dataset has SNPP_GSSTN/SNPP_GSSTD instead so we remove the LAC from the token search.

    my $night_or_day_value_from_filename = "";
    if (index($i_sst_filename,"_GSSTD") >= 0) {
        $night_or_day_value_from_filename = 'Day';
    }
    if (index($i_sst_filename,"_GSSTN") >= 0) {
        $night_or_day_value_from_filename = 'Night';
    }

    if ($debug_mode) {
        print $debug_module . "i_sst_filename [$i_sst_filename]\n";
        print $debug_module . "night_or_day_value_from_filename [$night_or_day_value_from_filename]\n";
    }

    # Return if was able to determine the night or day attribute from the file name.
    if ($night_or_day_value_from_filename ne "") {
        $o_night_or_day_flag = $night_or_day_value_from_filename;
        return ($o_night_or_day_flag);
    }

    my $idl_argument_strings = "-args \"$i_sst_filename\" ";

    my @args = ("/usr/local/bin/idl");

    if ($GHRSST_PERL_LIB_DIRECTORY == '') {
        $GHRSST_PERL_LIB_DIRECTORY = $ENV{GHRSST_PERL_LIB_DIRECTORY};
    }

    $rt_flag = "-rt=$GHRSST_PERL_LIB_DIRECTORY/is_granule_night_or_day.sav";
    $call_system_command_str = "$args[0] $rt_flag $idl_argument_strings";

print "call_system_command_str [$call_system_command_str]\n";

    my @results_lines = `$call_system_command_str`;
    foreach my $line (@results_lines ) {
        chomp($line);
        my @splitted_tokens = split(' ',$line);
        my $num_tokens = @splitted_tokens;
        if ($num_tokens == 2) {
            if ($splitted_tokens[0] == 'DAY_OR_NIGHT') {
                $o_night_or_day_flag = $splitted_tokens[1];  # The value we are looking for is the 2nd token.
            }
#print "splitted_tokens[1] [" . $o_night_or_day_flag . "]\n";
        }
    }

    #
    # Check for errors.
    #

    if ($? == -1) {
            print "is_granule_night_or_day: system [$call_system_command_str] failed to execute: $?\n";
            $o_status = 1;
    } elsif ($? == 256){
            print "is_granule_night_or_day: Cannot find file in system [$call_system_command_str].\n";
            $o_status = 1;
    } elsif ($? == 0){
#            print "is_granule_night_or_day: system $args[0] < $args[1] executed with: $?\n";
#            print "is_granule_night_or_day: Everything is OK.\n";
            $o_status = 0;
    } else {
            print "is_granule_night_or_day: system [$call_system_command_str] executed with: $?\n";
            $o_status = 1;
    }
    return($o_night_or_day_flag);
}

# Main program calls the subroutine defined above.
my $debug_module = "is_granule_night_or_day:";
my $module_name  = "is_granule_night_or_day.pl";

if (index($0,$module_name) >= 0)
{
    my $i_sst_filename = "/data/dev/scratch/qchau/scratch/combiner_output/from_netcdf_input_files_from_trunk_code_into_netcdf/viirs//2016/245/V2016245033600.SNPP_GSSTD.nc";
    my $o_night_or_day_flag = is_granule_night_or_day($i_sst_filename);
    print "i_sst_filename      $i_sst_filename\n";
    print "o_night_or_day_flag [$o_night_or_day_flag]\n";
}
1;
